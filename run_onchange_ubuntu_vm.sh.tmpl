#!/usr/bin/env bash

{{ if eq .chezmoi.os "linux" }}
{{ if eq .chezmoi.osRelease.id "ubuntu" }}

# test for running in codespaces by checking $CODESPACES
if [[ "${CODESPACES}" == "true" ]]; then
  echo "Not Running run_onchange_ubuntu_vm.sh in codespaces"
  exit 0
else
  echo "Running run_onchange_ubuntu_vm.sh"
fi

# check architecture
ARCH=$(dpkg --print-architecture)

# install githubcli repo
if ! [[ -f /usr/share/keyrings/githubcli-archive-keyring.gpg ]]; then
  echo "Adding githubcli GPG key..."
  wget -O- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
  sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
fi

if ! [[ -f /etc/apt/sources.list.d/hashicorp.list ]]; then
  echo "Adding Hashicorp repo..."
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
fi

# install golang if it's not installed
GO_VERSION="1.20.5"

# install go function
install_go() {
  echo "Installing golang from https://go.dev/dl/go${GO_VERSION}.linux-${ARCH}.tar.gz"
  wget -O go${GO_VERSION}.linux-${ARCH}.tar.gz https://go.dev/dl/go${GO_VERSION}.linux-${ARCH}.tar.gz
  # if archive exists then extract it
  if [[ -f go${GO_VERSION}.linux-${ARCH}.tar.gz ]]; then
    sudo tar -C /usr/local -xzf go${GO_VERSION}.linux-${ARCH}.tar.gz
    PATH=$PATH:/usr/local/go/bin
    go version
    rm go${GO_VERSION}.linux-${ARCH}.tar.gz
  fi
}

# check go version and install if necessary
if command -v go &> /dev/null; then
  GO_VERSION_INSTALLED=$(go version | awk '{print $3}' | sed 's/go//')
  echo "go is installed, version: $GO_VERSION"
  if command -v go &> /dev/null; then
    GO_VERSION_INSTALLED=$(go version | awk '{print $3}' | sed 's/go//')
    echo "go is installed, version: $GO_VERSION_INSTALLED"
    if [[ "$(printf '%s\n' "$GO_VERSION_INSTALLED" "$GO_VERSION" | sort -V | head -n1)" == "$GO_VERSION" ]]; then
      echo "go version $GO_VERSION is already installed"
    else
      install_go
    fi
  fi
else
  install_go
fi

# install vault-token-helper
if  command -v /usr/local/go/bin/go &>/dev/null; then
  if ! command -v $HOME/go/bin/vault-token-helper/vault-token-helper &>/dev/null; then
    echo "Installing vault-token-helper..."
    sudo /usr/local/go/bin/go install github.com/joemiller/vault-token-helper@latest
  fi
fi

# config git
if [ "$(git config --global push.default)" != "current" ]; then
    git config --global push.default current
fi
if [ "$(git config --global pull.rebase)" != "false" ]; then
    git config --global pull.rebase false
fi
if [ -z "$(git config --global user.name)" ]; then
    git config --global user.name "Blake Garner"
fi
if [ -z "$(git config --global user.email)" ]; then
    git config --global user.email blake@netjibbing.com
fi
if [ -z "$(git config --global alias.change-commits)" ]; then
    git config --global alias.change-commits '!'"f() { VAR=\$1; OLD=\$2; NEW=\$3; shift 3; git filter-branch --env-filter \"if [[ \\\"\$\`echo \$VAR\`\\\" = '\$OLD' ]]; then export \$VAR='\$NEW'; fi\" \$@; }; f"
fi
if [ "$(git config --global commit.gpgsign)" != "false" ]; then
    git config --global commit.gpgsign false
fi

{{ end }}
{{ end }}

exit 0
