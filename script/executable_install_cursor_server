#!/bin/bash

# Cursor Remote Server Installation Script
# This script downloads and installs the Cursor server on a remote system

set -e  # Exit on any error

# Configuration - you may need to adjust these
CURSOR_COMMIT="d750e54bba5cffada6d7b3d18e5688ba5e944ad0"  # Update this to match your local Cursor
CURSOR_VERSION="1.6.27"
CURSOR_SERVER_DIR="$HOME/.cursor-server"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# Detect system architecture
detect_arch() {
    local machine=$(uname -m)
    case "$machine" in
        x86_64)
            echo "x64"
            ;;
        arm64|aarch64)
            echo "arm64"
            ;;
        *)
            error "Unsupported architecture: $machine"
            ;;
    esac
}

# Detect platform
detect_platform() {
    local os=$(uname -s)
    case "$os" in
        Darwin)
            echo "darwin"
            ;;
        Linux)
            echo "linux"
            ;;
        *)
            error "Unsupported platform: $os"
            ;;
    esac
}

# Download and extract server
download_server() {
    local platform="$1"
    local arch="$2"
    
    # Try multiple download URLs
    local urls=(
        "https://cursor.blob.core.windows.net/cursor/stable-${CURSOR_COMMIT}/server-${platform}-${arch}.tar.gz"
        "https://update.code.visualstudio.com/commit:${CURSOR_COMMIT}/server-${platform}-${arch}/stable"
        "https://vscode.download.prss.microsoft.com/dbazure/download/stable/${CURSOR_COMMIT}/vscode-reh-${platform}-${arch}.tar.gz"
    )
    
    local temp_dir=$(mktemp -d)
    local downloaded=false
    
    for url in "${urls[@]}"; do
        log "Trying to download from: $url"
        
        if curl -L -f --progress-bar "$url" -o "$temp_dir/server.tar.gz"; then
            log "Successfully downloaded from: $url"
            downloaded=true
            break
        else
            warn "Failed to download from: $url"
        fi
    done
    
    if [ "$downloaded" = false ]; then
        error "Failed to download server from any URL"
    fi
    
    # Extract to server directory
    log "Extracting server to $CURSOR_SERVER_DIR"
    mkdir -p "$CURSOR_SERVER_DIR"
    tar -xzf "$temp_dir/server.tar.gz" -C "$CURSOR_SERVER_DIR" --strip-components=1
    
    # Cleanup
    rm -rf "$temp_dir"
}

# Create CLI directory structure
setup_cli_structure() {
    local platform="$1"
    local arch="$2"
    
    local cli_dir="$CURSOR_SERVER_DIR/cli/servers/Stable-${CURSOR_COMMIT}"
    
    log "Setting up CLI directory structure"
    mkdir -p "$cli_dir"
    
    # Create server directory and move files
    if [ -d "$CURSOR_SERVER_DIR/bin" ]; then
        mv "$CURSOR_SERVER_DIR"/* "$cli_dir/server/" 2>/dev/null || true
        mkdir -p "$cli_dir/server"
        mv "$CURSOR_SERVER_DIR"/* "$cli_dir/server/" 2>/dev/null || true
    fi
    
    # Create the cursor binary
    log "Creating cursor binary"
    if [ -f "$cli_dir/server/bin/cursor-server" ]; then
        cp "$cli_dir/server/bin/cursor-server" "$CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}"
        chmod +x "$CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}"
    elif [ -f "$cli_dir/server/node" ]; then
        cp "$cli_dir/server/node" "$CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}"
        chmod +x "$CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}"
    fi
    
    # Create LRU file
    echo "[\"Stable-${CURSOR_COMMIT}\"]" > "$CURSOR_SERVER_DIR/cli/servers/lru.json"
    
    # Create empty log files
    touch "$cli_dir/log.txt"
    touch "$cli_dir/pid.txt"
}

# Alternative: Download CLI binary directly
download_cli_binary() {
    local platform="$1"
    local arch="$2"
    
    local cli_urls=(
        "https://cursor.blob.core.windows.net/cursor/stable-${CURSOR_COMMIT}/cli-${platform}-${arch}.tar.gz"
        "https://update.code.visualstudio.com/commit:${CURSOR_COMMIT}/cli-${platform}-${arch}/stable"
    )
    
    local temp_dir=$(mktemp -d)
    local downloaded=false
    
    for url in "${cli_urls[@]}"; do
        log "Trying to download CLI from: $url"
        
        if curl -L -f --progress-bar "$url" -o "$temp_dir/cli.tar.gz"; then
            log "Successfully downloaded CLI from: $url"
            downloaded=true
            break
        else
            warn "Failed to download CLI from: $url"
        fi
    done
    
    if [ "$downloaded" = true ]; then
        log "Extracting CLI binary"
        tar -xzf "$temp_dir/cli.tar.gz" -C "$CURSOR_SERVER_DIR"
        chmod +x "$CURSOR_SERVER_DIR/cursor"
        mv "$CURSOR_SERVER_DIR/cursor" "$CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}"
    fi
    
    rm -rf "$temp_dir"
}

# Main installation process
main() {
    log "Starting Cursor server installation"
    log "Target directory: $CURSOR_SERVER_DIR"
    log "Commit ID: $CURSOR_COMMIT"
    log "Version: $CURSOR_VERSION"
    
    # Detect system info
    local platform=$(detect_platform)
    local arch=$(detect_arch)
    
    log "Detected platform: $platform"
    log "Detected architecture: $arch"
    
    # Remove existing installation
    if [ -d "$CURSOR_SERVER_DIR" ]; then
        warn "Removing existing installation at $CURSOR_SERVER_DIR"
        rm -rf "$CURSOR_SERVER_DIR"
    fi
    
    # Create base directory
    mkdir -p "$CURSOR_SERVER_DIR"
    
    # Try to download server
    log "Attempting to download server binary..."
    if download_server "$platform" "$arch"; then
        log "Server download successful"
        setup_cli_structure "$platform" "$arch"
    else
        warn "Server download failed, trying CLI binary..."
        download_cli_binary "$platform" "$arch"
    fi
    
    # Try to download CLI binary as well
    log "Downloading CLI binary..."
    download_cli_binary "$platform" "$arch"
    
    # Verify installation
    if [ -f "$CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}" ]; then
        log "✅ Installation successful!"
        log "Cursor binary: $CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}"
        
        # Test the binary
        if "$CURSOR_SERVER_DIR/cursor-${CURSOR_COMMIT}" --version 2>/dev/null; then
            log "✅ Binary is working correctly"
        else
            warn "⚠️  Binary may not be working correctly"
        fi
    else
        error "❌ Installation failed - cursor binary not found"
    fi
    
    log "Installation complete! You can now try connecting via Remote SSH."
}

# Check if curl is available
if ! command -v curl &> /dev/null; then
    error "curl is required but not installed"
fi

# Check if tar is available  
if ! command -v tar &> /dev/null; then
    error "tar is required but not installed"
fi

# Run main installation
main "$@"
