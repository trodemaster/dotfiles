#!/usr/bin/env bash

{{ if eq .chezmoi.os "darwin" }}

echo "Run once script for darwin"

# test for xcode command line tools
if ! xcode-select -p &>/dev/null; then
  echo "Installing xcode command line tools..."
  xcode-select --install
  sudo xcode-select -s /Library/Developer/CommandLineTools
fi

# get latest release version from github for macports
PORT_LATEST_RELEASE=$(curl -s https://api.github.com/repos/macports/macports-base/releases/latest | grep tag_name | cut -d '"' -f 4)
PORT_LATEST_RELEASE_NUMBER=${PORT_LATEST_RELEASE#v}

# get macOS operating system version long name including california parks using system_profiler
MACOS_VERSION=$(sw_vers --ProductVersion | cut -d . -f1)
MACOS_VERSION_NAME=$(awk '/SOFTWARE LICENSE AGREEMENT FOR macOS/' '/System/Library/CoreServices/Setup Assistant.app/Contents/Resources/en.lproj/OSXSoftwareLicense.rtf' | awk -F 'macOS ' '{print $NF}' | awk '{print substr($0, 0, length($0)-1)}')

# test for macports
if ! command -v /opt/local/bin/port &>/dev/null; then
  echo "Installing macports..."
  MACPORTS_PKG="https://github.com/macports/macports-base/releases/download/${PORT_LATEST_RELEASE}/MacPorts-${PORT_LATEST_RELEASE_NUMBER}-${MACOS_VERSION}-${MACOS_VERSION_NAME}.pkg"
  echo $MACPORTS_PKG
  curl -s -L -o /tmp/macports.pkg $MACPORTS_PKG
  sudo installer -pkg /tmp/macports.pkg -target /
  rm /tmp/macports.pkg
fi

# install packages
for PORT_PACKAGE in "${PORT_PACKAGES[@]}"; do
  if /opt/local/bin/port installed $PORT_PACKAGE | grep -q "None of the specified ports are installed"; then
    echo "Installing $PORT_PACKAGE..."
    sudo /opt/local/bin/port -q install $PORT_PACKAGE
  fi
done

# fixups after port installation
if [[ -e /opt/local/bin/python3.10 ]]; then
  sudo /opt/local/bin/port select --set python python310 || true
  sudo /opt/local/bin/port select --set python3 python310 || true
  sudo /opt/local/bin/port select --set virtualenv virtualenv310 || true
  sudo /opt/local/bin/port select --set pip pip310 || true
  sudo /opt/local/bin/port select --set pip3 pip310 || true
fi

{{ end }}

exit 0
