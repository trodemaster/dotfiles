#!/usr/bin/env bash

{{ if eq .chezmoi.os "darwin" }}

echo "Run once script for darwin"

# configure sudoers
if ! [[ -f /etc/sudoers.d/admin ]]; then
  echo "Adding admin group to sudoers..."
  echo '%admin     ALL=(ALL)       NOPASSWD: ALL' | sudo tee /etc/sudoers.d/admin
fi

# test for xcode command line tools
if ! xcode-select -p &>/dev/null; then
  echo "Installing xcode command line tools..."
  xcode-select --install
  sudo xcode-select -s /Library/Developer/CommandLineTools
fi

# get latest release version from github for macports
PORT_LATEST_RELEASE=$(curl -s https://api.github.com/repos/macports/macports-base/releases/latest | grep tag_name | cut -d '"' -f 4)
PORT_LATEST_RELEASE_NUMBER=${PORT_LATEST_RELEASE#v}

# get macOS operating system version long name including california parks using system_profiler
MACOS_VERSION=$(sw_vers --ProductVersion | cut -d . -f1)
MACOS_VERSION_NAME=$(awk '/SOFTWARE LICENSE AGREEMENT FOR macOS/' '/System/Library/CoreServices/Setup Assistant.app/Contents/Resources/en.lproj/OSXSoftwareLicense.rtf' | awk -F 'macOS ' '{print $NF}' | awk '{print substr($0, 0, length($0)-1)}')

# test for macports
if ! command -v /opt/local/bin/port &>/dev/null; then
  echo "Installing macports..."
  MACPORTS_PKG="https://github.com/macports/macports-base/releases/download/${PORT_LATEST_RELEASE}/MacPorts-${PORT_LATEST_RELEASE_NUMBER}-${MACOS_VERSION}-${MACOS_VERSION_NAME}.pkg"
  echo $MACPORTS_PKG
  curl -s -L -o /tmp/macports.pkg $MACPORTS_PKG
  sudo installer -pkg /tmp/macports.pkg -target /
  rm /tmp/macports.pkg
fi

# configure macports mirrors
#if ! grep -q "rsync://rsync.macports.org/macports/release/tarballs/ports.tar" /opt/local/etc/macports/sources.conf; then
#  echo "Configuring macports mirrors..."
#  sudo sed -i '' 's|rsync://rsync.macports.org/macports/release/tarballs/ports.tar|rsync://aarnet.au.rsync.macports.org/macports/release/tarballs/ports.tar|g' /opt/local/etc/macports/sources.conf
#  sudo sed -i '' 's|rsync://rsync.macports.org/macports/release/tarballs/base.tar|rsync://aarnet.au.rsync.macports.org/macports/release/tarballs/base.tar|g' /opt/local/etc/macports/sources.conf
#fi

# set macports python version
PYTHON3VERSION="311"

# macports packages to install
PORT_PACKAGES=(
  "git"
  "bash"
  "wget"
  "jq"
  "go"
  "fzf"
  "duf"
  "chezmoi"
  "python${PYTHON3VERSION}"
  "py${PYTHON3VERSION}-pip"
  "py${PYTHON3VERSION}-powerline"
  "py${PYTHON3VERSION}-virtualenv"
)

# install packages
export PATH="/opt/local/bin:/opt/local/sbin:$PATH"
sudo port selfupdate
for PORT_PACKAGE in "${PORT_PACKAGES[@]}"; do
  if /opt/local/bin/port installed $PORT_PACKAGE | grep -q "None of the specified ports are installed"; then
    echo "Installing $PORT_PACKAGE..."
    sudo /opt/local/bin/port -q install $PORT_PACKAGE
  fi
done

# fixups after port installation
if [[ -e /opt/local/bin/python3 ]]; then
  sudo /opt/local/bin/port select --set python python${PYTHON3VERSION} >/dev/null
  sudo /opt/local/bin/port select --set python3 python${PYTHON3VERSION} >/dev/null
  sudo /opt/local/bin/port select --set virtualenv virtualenv${PYTHON3VERSION} >/dev/null
  sudo /opt/local/bin/port select --set pip pip${PYTHON3VERSION} >/dev/null
  sudo /opt/local/bin/port select --set pip3 pip${PYTHON3VERSION} >/dev/null
fi

# Install source code pro font
if [[ ! -f /Library/Fonts/SourceCodePro-Medium.otf ]]; then
  echo "Installing source code pro font..."
  /opt/local/bin/wget -q https://github.com/adobe-fonts/source-code-pro/releases/download/2.038R-ro%2F1.058R-it%2F1.018R-VAR/OTF-source-code-pro-2.038R-ro-1.058R-it.zip -O ~/OTF-source-code-pro.zip
  unzip -o -d /Library/Fonts/ ~/OTF-source-code-pro.zip SourceCodePro-Medium.otf
  rm ~/OTF-source-code-pro.zip
fi

# update /etc/shells
if ! grep -q "/opt/local/bin/bash" /etc/shells; then
  sudo tee -a /etc/shells <<<"/opt/local/bin/bash"
fi

# set bash 5 as default shell
if [[ -e /opt/local/bin/bash ]]; then
  sudo chsh -s /opt/local/bin/bash $USER
fi

{{ end }}

exit 0
